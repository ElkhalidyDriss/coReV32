--------------------------------------------------------------------------------
--  Author: Driss Elkhalidy , an embedded systems engineering student 
--          at National Institute of Posts and Telecommunications , Rabat , Morocco.
--  Description : Implementation of register file of risc-v in VHDL
------------------------------------------------------------------------------

library ieee;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;


entity rv_reg_file is generic ( DATA_WIDTH : natural := 32;
                               ADDR_WIDTH : natural := 5);
port ( clk  : in std_logic;
       we : in std_logic ;--write enable signal 
       raddr1 : in std_logic_vector(ADDR_WIDTH - 1 downto 0);--read address 
       raddr2 : in std_logic_vector(ADDR_WIDTH - 1 downto 0);
       waddr : in std_logic_vector(ADDR_WIDTH - 1 downto 0); --address of the register we want to write into
       wdata    : in std_logic_vector(DATA_WIDTH - 1 downto 0); --the data should be written into the reg specified by waddr
       rdata1 : out std_logic_vector(DATA_WIDTH - 1 downto 0);--read data output of ra1
       rdata2 : out std_logic_vector(DATA_WIDTH - 1 downto 0)--read data output of ra2
      );
end entity;

architecture rv_regFile_arch of rv_regFile is 
type regs_array is array (0 to (2**ADDR_WIDTH)-1) of std_logic_vector(DATA_WIDTH-1 downto 0);
signal regs : regs_array :=(others => (others => '0')) ;--registers x0 , x1 ... x31
constant ZERO : std_logic_vector(ADDR_WIDTH - 1 downto 0) :=(others => '0');

begin 
process (clk)
begin 
     if rising_edge(clk) then 
        if (we = '1' and waddr /= ZERO) then --Ensuring that the x0 reg remains zero 
            regs(to_integer(unsigned(waddr))) <= wdata;
         end if;
      end if;
end process;
rdata1 <= regs(to_integer(unsigned(raddr1)));
rdata2 <= regs(to_integer(unsigned(raddr2)));
end architecture;